<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<?xml-stylesheet type="text/xsl" href="../../jgenhtml.xsl"?><coverage branch-rate="NaN" branches-covered="0" branches-valid="0" complexity="0" date="2023-01-04" filename="_client.dart" function-rate="NaN" functions-covered="0" functions-valid="0" line-rate="0.7017544" lines-covered="80" lines-valid="114" package="/src/client" testname="lcov.info" version="1.5">
<lines>
<line>
<code>import 'dart:async';</code>
</line>
<line>
<code>import 'dart:convert';</code>
</line>
<line>
<code/>
</line>
<line>
<code>import 'package:crypto/crypto.dart' as crypto;</code>
</line>
<line>
<code>import 'package:http/http.dart' as http;</code>
</line>
<line>
<code>import 'package:retry/retry.dart';</code>
</line>
<line>
<code/>
</line>
<line>
<code>import '../_internal/_authorization.dart';</code>
</line>
<line>
<code>import '../_internal/_http_call.dart';</code>
</line>
<line>
<code>import '../_internal/_http_header.dart';</code>
</line>
<line>
<code>import '../_internal/_http_status_codes.dart';</code>
</line>
<line>
<code>import '../_internal/_mime_type.dart';</code>
</line>
<line>
<code>import '../base_document.dart';</code>
</line>
<line>
<code>import '../batch/transactional_batch.dart';</code>
</line>
<line>
<code>import '../cosmos_db_exceptions.dart';</code>
</line>
<line>
<code>import '../queries/paging.dart';</code>
</line>
<line>
<code>import '../queries/query.dart';</code>
</line>
<line>
<code>import '_context.dart';</code>
</line>
<line>
<code>import '_retry_if_web.dart' if (dart.library.io) '_retry_if_vm.dart';</code>
</line>
<line>
<code/>
</line>
<line>
<code>typedef _DocumentBuilder = DocumentBuilder&lt;BaseDocument&gt;;</code>
</line>
<line>
<code/>
</line>
<line>
<code>class Client {</code>
</line>
<line hits="1">
<code>  Client(</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line>
<code>    this._url, {</code>
</line>
<line>
<code>    String? masterKey,</code>
</line>
<line>
<code>    this.multipleWriteLocations = false,</code>
</line>
<line>
<code>    http.Client? httpClient,</code>
</line>
<line>
<code>    RetryOptions? retryOptions,</code>
</line>
<line hits="1">
<code>  })  : _http = httpClient ?? http.Client(),</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line hits="1">
<code>        _retry = retryOptions ?? RetryOptions() {</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line>
<code>    if (masterKey != null) {</code>
</line>
<line hits="3">
<code>      _key = crypto.Hmac(crypto.sha256, base64Decode(masterKey));</code>
<hit count="3" name="&lt;unnamed&gt;"/>
</line>
<line>
<code>    } else {</code>
</line>
<line hits="1">
<code>      _key = null;</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line>
<code>    }</code>
</line>
<line>
<code>  }</code>
</line>
<line>
<code/>
</line>
<line>
<code>  final String _url;</code>
</line>
<line>
<code>  final bool multipleWriteLocations;</code>
</line>
<line>
<code>  final RetryOptions _retry;</code>
</line>
<line>
<code/>
</line>
<line>
<code>  late final crypto.Hmac? _key;</code>
</line>
<line>
<code>  late final http.Client _http;</code>
</line>
<line>
<code/>
</line>
<line>
<code>  final _builders = &lt;Type, _DocumentBuilder&gt;{};</code>
</line>
<line>
<code/>
</line>
<line hits="2">
<code>  http.Client get httpClient =&gt; _http;</code>
<hit count="2" name="&lt;unnamed&gt;"/>
</line>
<line>
<code/>
</line>
<line hits="1">
<code>  void registerBuilder&lt;T extends BaseDocument&gt;(DocumentBuilder&lt;T&gt; builder) {</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line hits="2">
<code>    _builders[T] = builder;</code>
<hit count="2" name="&lt;unnamed&gt;"/>
</line>
<line>
<code>  }</code>
</line>
<line>
<code/>
</line>
<line hits="1">
<code>  DocumentBuilder&lt;T&gt; _getBuilder&lt;T extends BaseDocument&gt;(Context context) {</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line hits="3">
<code>    final builder = context.builder ?? _builders[T];</code>
<hit count="3" name="&lt;unnamed&gt;"/>
</line>
<line hits="0">
<code>    if (builder == null) throw UnknownDocumentTypeException(T);</code>
</line>
<line hits="1">
<code>    return (data) {</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line>
<code>      try {</code>
</line>
<line hits="1">
<code>        return builder(data) as T;</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line>
<code>      } catch (ex) {</code>
</line>
<line hits="0">
<code>        throw BadResponseException(ex.toString());</code>
</line>
<line>
<code>      }</code>
</line>
<line>
<code>    };</code>
</line>
<line>
<code>  }</code>
</line>
<line>
<code/>
</line>
<line hits="1">
<code>  T? _build&lt;T extends BaseDocument&gt;(Context context, Map? item) {</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line hits="1">
<code>    final builder = _getBuilder&lt;T&gt;(context);</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line hits="2">
<code>    return (item == null || item.isEmpty) ? null : builder(item);</code>
<hit count="2" name="&lt;unnamed&gt;"/>
</line>
<line>
<code>  }</code>
</line>
<line>
<code/>
</line>
<line hits="1">
<code>  Iterable&lt;T&gt; _buildMany&lt;T extends BaseDocument&gt;(Context context, List? items) {</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line hits="1">
<code>    final builder = _getBuilder&lt;T&gt;(context);</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line hits="3">
<code>    return (items ?? []).map((item) =&gt; builder(item));</code>
<hit count="3" name="&lt;unnamed&gt;"/>
</line>
<line>
<code>  }</code>
</line>
<line>
<code/>
</line>
<line hits="1">
<code>  Future&lt;http.StreamedResponse&gt; _sendWithAuth(</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line>
<code>    HttpCall call,</code>
</line>
<line>
<code>    BaseDocument? body,</code>
</line>
<line>
<code>    Context context,</code>
</line>
<line>
<code>    Authorization authorization,</code>
</line>
<line>
<code>  ) {</code>
</line>
<line hits="2">
<code>    final request = call.getRequest(_url, authorization);</code>
<hit count="2" name="&lt;unnamed&gt;"/>
</line>
<line>
<code/>
</line>
<line>
<code>    if (body != null) {</code>
</line>
<line hits="2">
<code>      request.headers.addAll(HttpHeader.jsonPayload);</code>
<hit count="2" name="&lt;unnamed&gt;"/>
</line>
<line hits="2">
<code>      request.body = jsonEncode(body);</code>
<hit count="2" name="&lt;unnamed&gt;"/>
</line>
<line>
<code>    }</code>
</line>
<line hits="1">
<code>    if (multipleWriteLocations &amp;&amp; !call.method.isReadOnly) {</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line hits="0">
<code>      request.headers.addAll(HttpHeader.allowTentativeWrites);</code>
</line>
<line>
<code>    }</code>
</line>
<line>
<code/>
</line>
<line hits="3">
<code>    request.headers.addAll(context.getHeaders());</code>
<hit count="3" name="&lt;unnamed&gt;"/>
</line>
<line>
<code/>
</line>
<line hits="2">
<code>    return _retry.retry(</code>
<hit count="2" name="&lt;unnamed&gt;"/>
</line>
<line hits="5">
<code>      () =&gt; _http.send(request).timeout(Duration(seconds: 5)),</code>
<hit count="5" name="&lt;unnamed&gt;"/>
</line>
<line hits="3">
<code>      retryIf: (e) =&gt; retryIf(_http, e),</code>
<hit count="3" name="&lt;unnamed&gt;"/>
</line>
<line>
<code>    );</code>
</line>
<line>
<code>  }</code>
</line>
<line>
<code/>
</line>
<line hits="1">
<code>  Future&lt;dynamic&gt; _send(</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line>
<code>    HttpCall call,</code>
</line>
<line>
<code>    BaseDocument? body,</code>
</line>
<line>
<code>    Context context,</code>
</line>
<line>
<code>  ) async {</code>
</line>
<line hits="2">
<code>    String resId = context.resId ?? call.uri;</code>
<hit count="2" name="&lt;unnamed&gt;"/>
</line>
<line>
<code/>
</line>
<line hits="1">
<code>    var auth = (context.token != null)</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line hits="2">
<code>        ? Authorization.fromToken(context.token!)</code>
<hit count="2" name="&lt;unnamed&gt;"/>
</line>
<line hits="1">
<code>        : Authorization.fromKey(</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line hits="5">
<code>            _key, call.method.name.toLowerCase(), context.type, resId);</code>
<hit count="5" name="&lt;unnamed&gt;"/>
</line>
<line>
<code/>
</line>
<line hits="1">
<code>    var result = await _sendWithAuth(call, body, context, auth);</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line>
<code/>
</line>
<line hits="1">
<code>    switch (result.statusCode) {</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line hits="1">
<code>      case HttpStatusCode.forbidden:</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line>
<code>        // try to get a new permission from the onForbidden callback</code>
</line>
<line hits="2">
<code>        final permission = await context.onForbidden?.call();</code>
<hit count="2" name="&lt;unnamed&gt;"/>
</line>
<line hits="1">
<code>        final token = permission?.token;</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line>
<code>        if (token != null) {</code>
</line>
<line>
<code>          // try again with this permission</code>
</line>
<line hits="1">
<code>          auth = Authorization.fromToken(token);</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line hits="1">
<code>          result = await _sendWithAuth(call, body, context, auth);</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line>
<code>        }</code>
</line>
<line>
<code>        break;</code>
</line>
<line hits="1">
<code>      case HttpStatusCode.tooManyRequests:</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line>
<code>        // throttling, retry after the specified delay</code>
</line>
<line>
<code>        final delay =</code>
</line>
<line hits="0">
<code>            int.tryParse(result.headers[HttpHeader.msRetryAfterMs] ?? '');</code>
</line>
<line>
<code>        if (delay != null) {</code>
</line>
<line hits="0">
<code>          await Future.delayed(Duration(milliseconds: delay));</code>
</line>
<line hits="0">
<code>          result = await _sendWithAuth(call, body, context, auth);</code>
</line>
<line>
<code>        }</code>
</line>
<line>
<code>        break;</code>
</line>
<line>
<code>    }</code>
</line>
<line>
<code/>
</line>
<line hits="2">
<code>    final contentType = result.headers[HttpHeader.contentType];</code>
<hit count="2" name="&lt;unnamed&gt;"/>
</line>
<line hits="1">
<code>    if (contentType != MimeType.json) {</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line hits="0">
<code>      throw BadResponseException('Unsupported content-type: $contentType');</code>
</line>
<line>
<code>    }</code>
</line>
<line hits="2">
<code>    final response = await result.stream.bytesToString();</code>
<hit count="2" name="&lt;unnamed&gt;"/>
</line>
<line hits="3">
<code>    dynamic data = response.isEmpty ? {} : jsonDecode(response);</code>
<hit count="3" name="&lt;unnamed&gt;"/>
</line>
<line>
<code/>
</line>
<line hits="2">
<code>    if (!HttpStatusCode.success(result.statusCode)) {</code>
<hit count="2" name="&lt;unnamed&gt;"/>
</line>
<line hits="2">
<code>      final message = (data is Map &amp;&amp; data.containsKey('message'))</code>
<hit count="2" name="&lt;unnamed&gt;"/>
</line>
<line hits="2">
<code>          ? '${result.reasonPhrase}: ${data['message']}'</code>
<hit count="2" name="&lt;unnamed&gt;"/>
</line>
<line hits="1">
<code>          : result.reasonPhrase;</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line hits="2">
<code>      final ex = CosmosDbException(result.statusCode, message);</code>
<hit count="2" name="&lt;unnamed&gt;"/>
</line>
<line hits="2">
<code>      if (ex is! NotFoundException || context.throwOnNotFound) {</code>
<hit count="2" name="&lt;unnamed&gt;"/>
</line>
<line>
<code>        throw ex;</code>
</line>
<line>
<code>      }</code>
</line>
<line>
<code>      // set data to null when ignoring the error</code>
</line>
<line>
<code>      data = null;</code>
</line>
<line>
<code>    }</code>
</line>
<line>
<code/>
</line>
<line hits="1">
<code>    context.paging?.setContinuation(</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line hits="0">
<code>      result.headers[HttpHeader.msContinuation] ?? '',</code>
</line>
<line>
<code>    );</code>
</line>
<line>
<code>    return data;</code>
</line>
<line>
<code>  }</code>
</line>
<line>
<code/>
</line>
<line hits="1">
<code>  Future&lt;dynamic&gt; rawGet(String path, Context context) {</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line hits="1">
<code>    final call = HttpCall.get(path);</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line hits="2">
<code>    return _send(call, null, context).rethrowContextualizedException(call);</code>
<hit count="2" name="&lt;unnamed&gt;"/>
</line>
<line>
<code>  }</code>
</line>
<line>
<code/>
</line>
<line hits="1">
<code>  Future&lt;T?&gt; get&lt;T extends BaseDocument&gt;(String path, Context context) {</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line hits="1">
<code>    final call = HttpCall.get(path);</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line hits="1">
<code>    return _send(call, null, context)</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line hits="3">
<code>        .then((data) =&gt; _build&lt;T&gt;(context, data))</code>
<hit count="3" name="&lt;unnamed&gt;"/>
</line>
<line hits="1">
<code>        .rethrowContextualizedException(call);</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line>
<code>  }</code>
</line>
<line>
<code/>
</line>
<line hits="1">
<code>  Future&lt;Iterable&lt;T&gt;&gt; getMany&lt;T extends BaseDocument&gt;(</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line>
<code>      String path, String resultSet, Context context) {</code>
</line>
<line hits="1">
<code>    final call = HttpCall.get(path);</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line hits="1">
<code>    return _send(call, null, context)</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line hits="4">
<code>        .then((result) =&gt; _buildMany&lt;T&gt;(context, result![resultSet]))</code>
<hit count="4" name="&lt;unnamed&gt;"/>
</line>
<line hits="1">
<code>        .rethrowContextualizedException(call);</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line>
<code>  }</code>
</line>
<line>
<code/>
</line>
<line hits="0">
<code>  Future&lt;Iterable&lt;T&gt;&gt; query&lt;T extends BaseDocument&gt;(</code>
</line>
<line>
<code>      String path, Query query, String resultSet, Context context) {</code>
</line>
<line hits="0">
<code>    final call = HttpCall.post(path);</code>
</line>
<line hits="0">
<code>    return _send(</code>
</line>
<line>
<code>            call,</code>
</line>
<line>
<code>            query,</code>
</line>
<line hits="0">
<code>            context.copyWith(</code>
</line>
<line>
<code>              paging: query,</code>
</line>
<line hits="0">
<code>              partitionKey: query.partitionKey,</code>
</line>
<line>
<code>              headers: HttpHeader.queryPayload,</code>
</line>
<line>
<code>            ))</code>
</line>
<line hits="0">
<code>        .then((result) =&gt; _buildMany&lt;T&gt;(context, result![resultSet]))</code>
</line>
<line hits="0">
<code>        .rethrowContextualizedException(call);</code>
</line>
<line>
<code>  }</code>
</line>
<line>
<code/>
</line>
<line hits="0">
<code>  Future&lt;dynamic&gt; rawQuery(</code>
</line>
<line>
<code>      String path, Query query, String resultSet, Context context) {</code>
</line>
<line hits="0">
<code>    final call = HttpCall.post(path);</code>
</line>
<line hits="0">
<code>    return _send(</code>
</line>
<line>
<code>        call,</code>
</line>
<line>
<code>        query,</code>
</line>
<line hits="0">
<code>        context.copyWith(</code>
</line>
<line>
<code>          paging: query,</code>
</line>
<line hits="0">
<code>          partitionKey: query.partitionKey,</code>
</line>
<line>
<code>          headers: HttpHeader.queryPayload,</code>
</line>
<line hits="0">
<code>        )).rethrowContextualizedException(call);</code>
</line>
<line>
<code>  }</code>
</line>
<line>
<code/>
</line>
<line hits="0">
<code>  Future&lt;dynamic&gt; batch(</code>
</line>
<line>
<code>      String path, TransactionalBatch batch, Context context) {</code>
</line>
<line hits="0">
<code>    final call = HttpCall.post(path);</code>
</line>
<line hits="0">
<code>    return _send(</code>
</line>
<line>
<code>        call,</code>
</line>
<line>
<code>        batch,</code>
</line>
<line hits="0">
<code>        context.copyWith(</code>
</line>
<line hits="0">
<code>          headers: Map.from(batch.isAtomic</code>
</line>
<line>
<code>              ? HttpHeader.atomicBatchRequest</code>
</line>
<line>
<code>              : HttpHeader.nonAtomicBatchRequest)</code>
</line>
<line hits="0">
<code>            ..addAll({</code>
</line>
<line>
<code>              'x-ms-documentdb-partitionkeyrangeid': '0',</code>
</line>
<line>
<code>              'x-ms-cosmos-batch-continue-on-error':</code>
</line>
<line hits="0">
<code>                  batch.isAtomic ? 'false' : 'true'</code>
</line>
<line>
<code>            }),</code>
</line>
<line hits="0">
<code>        )).rethrowContextualizedException(call);</code>
</line>
<line>
<code>  }</code>
</line>
<line>
<code/>
</line>
<line hits="1">
<code>  Future&lt;T&gt; post&lt;T extends BaseDocument&gt;(</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line>
<code>      String path, BaseDocument doc, Context context) {</code>
</line>
<line hits="1">
<code>    final call = HttpCall.post(path);</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line hits="1">
<code>    return _send(call, doc, context)</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line hits="3">
<code>        .then((data) =&gt; _build&lt;T&gt;(context, data)!)</code>
<hit count="3" name="&lt;unnamed&gt;"/>
</line>
<line hits="1">
<code>        .rethrowContextualizedException(call);</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line>
<code>  }</code>
</line>
<line>
<code/>
</line>
<line hits="0">
<code>  Future&lt;T&gt; patch&lt;T extends BaseDocument&gt;(</code>
</line>
<line>
<code>      String path, BaseDocument doc, Context context) {</code>
</line>
<line hits="0">
<code>    final call = HttpCall.patch(path);</code>
</line>
<line hits="0">
<code>    return _send(call, doc, context.copyWith(headers: HttpHeader.patchPayload))</code>
</line>
<line hits="0">
<code>        .then((data) =&gt; _build&lt;T&gt;(context, data)!)</code>
</line>
<line hits="0">
<code>        .rethrowContextualizedException(call);</code>
</line>
<line>
<code>  }</code>
</line>
<line>
<code/>
</line>
<line hits="1">
<code>  Future&lt;T&gt; put&lt;T extends BaseDocument&gt;(</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line>
<code>      String path, BaseDocument doc, Context context) {</code>
</line>
<line hits="1">
<code>    final call = HttpCall.put(path);</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line hits="1">
<code>    return _send(call, doc, context)</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line hits="3">
<code>        .then((data) =&gt; _build&lt;T&gt;(context, data)!)</code>
<hit count="3" name="&lt;unnamed&gt;"/>
</line>
<line hits="1">
<code>        .rethrowContextualizedException(call);</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line>
<code>  }</code>
</line>
<line>
<code/>
</line>
<line hits="1">
<code>  Future&lt;bool&gt; delete(String path, Context context) {</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line hits="1">
<code>    final call = HttpCall.delete(path);</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line hits="1">
<code>    return _send(call, null, context)</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line hits="2">
<code>        .then((result) =&gt; true)</code>
<hit count="2" name="&lt;unnamed&gt;"/>
</line>
<line hits="1">
<code>        .rethrowContextualizedException(call);</code>
<hit count="1" name="&lt;unnamed&gt;"/>
</line>
<line>
<code>  }</code>
</line>
<line>
<code>}</code>
</line>
</lines>
<config branch-coverage="true" description-file="false" function-coverage="true" genhtml_hi_limit="90" genhtml_med_limit="75" legend="false" no-sort="false" no-source="false"/>
<base href="../../"/>
<base href="../../"/>
</coverage>
